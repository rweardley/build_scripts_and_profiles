# NekRS on DAWN

The scripts in this directory can be used to build and run NekRS on the DAWN `pvc9` partition. They must all be in the same directory such that `build_submit.dawn` can run `build_NekRS.sh`, and for `build_NekRS.sh` to find `nrsqsub_dawn_modified` to install this in the `nekRS/bin` directory.

# Building NekRS

NekRS can be installed using the `build_NekRS.sh` script, either in an interactive job on the `pvc9` nodes or by submitting `build_submit.dawn` as a job on the `pvc9` nodes with `sbatch build_submit.dawn`. This script will by default build and install NekRS in `${MY_RDS}/NekRS/DAWN/v24-dev_${DATE_TODAY}/nekRS`, where `MY_RDS` is an environment variable giving the full path to the user's directory in the RDS storage area and `DATE_TODAY` is set in the script as the date on which NekRS is installed. This script will also write a profile which can be sourced to set up the environment for the new NekRS installation, `source $HOME/.nekrs_dawn_v24-dev_${DATE_TODAY}_profile`.

If the `nrsqsub_dawn_modified` script is in the present working directory, it will be installed to `nekRS/bin` when NekRS is installed. This script will be added to the path when the NekRS profile is sourced.

# Running NekRS on DAWN

The DAWN nodes each feature 4 Intel Data Centre GPU Max 1550 devices (also referred to as PVC/Ponte Vecchio), each of which has 2 tiles that can be used as a discrete device. Therefore, unless running on less than a full node NekRS should be run with 8 ranks per node, with jobs requesting 4 GPUs (`--gres=gpu:4`).

The `nrsqsub_dawn_modified` script is provided to be used when running on one or more full nodes. This writes and submits a build script to run a NekRS case, setting additional environment variables required for running NekRS on this architecture, as well as generating a `.helper` script that is used in the `mpiexec` command to run NekRS. This script functions in the same way as other `nrsqsub` scripts provided with NekRS, and a summary of the usage can be obtained by running `nrsqsub_dawn_modified` without arguments.

```
$ nrsqsub_dawn_modified
Usage: [<env-var>] ./nrsqsub_dawn_modified <par or sess file> <number of compute nodes> <hh:mm>

  env-var                 Values(s)   Description / Comment
  ------------------------------------------------------------------------------------
  NEKRS_HOME              string      path to installation
  PROJ_ID                 string      
  QUEUE                   string      
  CPUONLY                 0/1         backend=serial
  RUN_ONLY                0/1         skip pre-compilation
  BUILD_ONLY              0/1         run pre-compilation only
  FP32                    0/1         run solver in single precision
  OPT_ARGS                string      optional arguements e.g. "--cimode 1 --debug"
```

It should be noted that while `nrsqsub_dawn_modified` has been tested and works on DAWN with good parallel scaling, it is a work in progress and there may be further optimisations that could be made.

NekRS can also be run on less than a full node on DAWN, in which case the `build_submit.dawn` script or the script generated by `nrsqsub_dawn_modified` can be used as a template. The default behaviour should be for each MPI rank to bind 1 PVC tile (rather than 1 GPU), but if the `nrsqsub_dawn_modified` script is not being used this may require additional testing.